(function(i,o){typeof exports=="object"&&typeof module<"u"?o(exports):typeof define=="function"&&define.amd?define(["exports"],o):(i=typeof globalThis<"u"?globalThis:i||self,o(i.Kamome={}))})(this,function(i){"use strict";var D=Object.defineProperty;var F=(i,o,c)=>o in i?D(i,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):i[o]=c;var A=(i,o,c)=>(F(i,typeof o!="symbol"?o+"":o,c),c);class o{hasClient(){return navigator.userAgent.toLowerCase().indexOf("android")>0&&"kamomeAndroid"in window}send(e){setTimeout(()=>window.kamomeAndroid.kamomeSend(e),0)}}class c{hasClient(){return"webkit"in window&&!!window.webkit.messageHandlers.kamomeSend}send(e){setTimeout(()=>window.webkit.messageHandlers.kamomeSend.postMessage(e),0)}}class b{hasClient(){return"kamomeFlutter"in window||"flutter_inappwebview"in window}send(e){"kamomeFlutter"in window?setTimeout(()=>window.kamomeFlutter.postMessage(e),0):"flutter_inappwebview"in window&&setTimeout(()=>window.flutter_inappwebview.callHandler("kamomeFlutter",e),0)}}const m={requestTimeout:"RequestTimeout",rejected:"Rejected",canceled:"Canceled"},h=50300;function T(r){return r===void 0?null:r}function q(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,r=>{const e=Math.random()*16|0;return(r==="x"?e:e&3|8).toString(16)}).toLowerCase()}class E{constructor(e={}){this.handlerDict=e}addCommand(e,t){return this.handlerDict[e]=t,this}removeCommand(e){return this.hasCommand(e)&&delete this.handlerDict[e],this}hasCommand(e){return e in this.handlerDict}send(e,t){return new Promise((s,n)=>{const d=`_km_${e}_${q()}`;this.addCommand(d,(l,k,S)=>{const p=l;if(p)if(p.success)s(p.result);else{const P=p.error||"UnknownError";n(P)}else n("UnknownError");k(),this.removeCommand(d)}),a.onReceive(e,t,d)})}execCommand(e){setTimeout(()=>{const t=n=>{const d=T(n);a.onComplete(d,e.id)},s=n=>{a.onError(n?encodeURIComponent(n):null,e.id)};this.handlerDict[e.name](T(e.data),t,s)},0)}}const y="_kamomeSYN",g="_kamomeACK",w=new o,f=new c,C=new b,u=new E;let v=!1,O=0,x=null;const R=class R{constructor(e={},t={},s=1e4){this.receivers=e,this.requests=t,this.requestTimeout=s}static get VERSION_CODE(){return h}static get Error(){return m}static get android(){return w}static get iOS(){return f}static get flutter(){return C}static get browser(){return u}static isReady(){return v}static setReadyEventListener(e){return x=e,this.instance}static setDefaultRequestTimeout(e){return this.instance.requestTimeout=e,this.instance}static hasNoClients(){return!f.hasClient()&&!w.hasClient()&&!C.hasClient()}static addReceiver(e,t){return this.instance.receivers[e]=t,this.instance}static removeReceiver(e){return e in this.instance.receivers&&delete this.instance.receivers[e],this.instance}static send(e,t,s){const n=s||this.instance.requestTimeout;return new Promise((d,l)=>{const k=q(),S={id:k,name:e,data:t,timeout:n,resolve:d,reject:l};this.instance.requests[k]=S,e===y||e===g?this.sendRequest(S):this.waitForReadyAndSendRequests()})}static sendRequest(e){const t=T(e.data),s=JSON.stringify({name:e.name,data:t,id:e.id});f.hasClient()?f.send(s):w.hasClient()?w.send(s):C.hasClient()?C.send(s):u.hasCommand(e.name)&&u.execCommand(e),e.timeout>0&&setTimeout(()=>{const n=this.instance.requests[e.id];n&&(n.reject(m.requestTimeout+":"+n.name),delete this.instance.requests[n.id])},e.timeout)}static waitForReadyAndSendRequests(){if(!v){O<50?(O++,setTimeout(this.waitForReadyAndSendRequests,200)):console.error("[kamome.js] Waiting for ready has timed out.");return}for(const e in this.instance.requests){const t=this.instance.requests[e];this.sendRequest(t)}}static onComplete(e,t){const s=this.instance.requests[t];return s&&(s.resolve(e),delete this.instance.requests[t]),null}static onError(e,t){const s=this.instance.requests[t];if(s){const n=e?":"+decodeURIComponent(e):"";s.reject(m.rejected+":"+s.name+n),delete this.instance.requests[t]}return null}static onReceive(e,t,s){return e in this.instance.receivers&&new Promise((n,d)=>{const l=this.instance.receivers[e];l(t,n,d)}).then(n=>this.send(s,{result:n||null,success:!0})).catch(n=>this.send(s,{error:n||null,success:!1})),null}};A(R,"instance",new R);let a=R;u.addCommand(y,(r,e)=>e({versionCode:h})),u.addCommand(g,(r,e)=>e());function _(){a.send(y,null,5e3).then(r=>{h!==r.versionCode&&console.warn("[kamome.js] The Kamome native library version does not match. Please update it to latest version."),v=!0,setTimeout(()=>x==null?void 0:x(),0),a.send(g,null,5e3).catch(()=>console.warn("[kamome.js] Failed to send ACK."))}).catch(()=>{console.warn("[kamome.js] Failed to send SYN. Please update the Kamome native library to latest version."),v=!0})}"flutter_inappwebview"in window?window.addEventListener("flutterInAppWebViewPlatformReady",_):window.addEventListener("DOMContentLoaded",_),window.KM=a,i.AndroidPlatform=o,i.FlutterPlatform=b,i.IosPlatform=c,i.KM=a,i.KamomeError=m,i.VERSION_CODE=h,i.WebBrowser=E,Object.defineProperty(i,Symbol.toStringTag,{value:"Module"})});
